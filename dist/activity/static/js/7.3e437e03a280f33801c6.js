webpackJsonp([7],{KVW0:function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var a=i("//Fk"),n=i.n(a),s=i("Xxa5"),r=i.n(s),o=i("exGp"),c=i.n(o),p=i("PJh5"),u=i.n(p),l=i("stRE"),d=i("oyxo"),h={metaInfo:{title:"签到"},mixins:[l.a],data:function(){return{id:"",signType:"",appId:"",corpid:"",corpurl:"",info:{},wlat:"",wlng:"",zoom:15,center:[121.59996,31.197646],componentMarker:{position:[121.59996,31.197646]},circles:[{center:[121.59996,31.197646],radius:200,fillOpacity:.5}],showPage:!1,shareMsg:{}}},created:function(){var t=this;return c()(r.a.mark(function e(){var i;return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.signType=t.$route.query.sign_type,t.id=t.$route.query.id,t.appId=t.$route.query.appid,t.corpid=t.$route.query.corpid,t.corpurl=t.$route.query.corpurl,e.next=7,t.getLoginState();case 7:if(e.sent){e.next=13;break}i="/activity/login?pathName=Scan_sign_in2&sign_type=2&id="+t.id+"&corpid="+t.corpid+"&corpurl="+t.corpurl+"&appid="+t.appId,t.$router.replace({path:i}),e.next=24;break;case 13:if(t.getShareMsg(),1!==Number(t.signType)){e.next=23;break}return d.c.initJssdkCon(["openLocation","getLocation"]),e.next=18,t.getMessage();case 18:return e.next=20,t.ref();case 20:t.showPage=!0,e.next=24;break;case 23:t.signedEventCode(1);case 24:case"end":return e.stop()}},e,t)}))()},methods:{getLoginState:function(){return new n.a(function(t,e){d.b.post("/index.php?m=login&cmd=102",{}).then(function(e){var i=!1;0!==Number(e.info.state)&&(i=!0),t(i)})})},getShareMsg:function(){var t=this;d.b.post("/index.php?app=activity&m=act&cmd=203",{}).then(function(e){t.shareMsg.appid=e.info.appid,t.shareMsg.corpid=e.info.corpid,t.shareMsg.corpurl=e.info.corpurl}),d.b.post("/index.php?app=activity&m=act&cmd=102",{data:{type:1}}).then(function(e){t.shareMsg.shareId=e.info.curr_user_id})},ref:function(){var t=this;return new n.a(function(e){t.$toast.loading({message:"获取定位中...",duration:0}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(i){t.$toast.close(),t.wlat=parseFloat(i.latitude),t.wlng=parseFloat(i.longitude),t.changeLocation(),e(!0)}})})})},changeLocation:function(){var t=this;d.b.post("/index.php?app=activity&m=act&cmd=118",{data:{lng:this.wlng,lat:this.wlat}}).then(function(e){0===Number(e.errcode)&&(t.componentMarker.position=[parseFloat(e.info.lng),parseFloat(e.info.lat)])})},signedEvent:function(t){var e=this,i=this.getDistance(parseFloat(this.componentMarker.position[1]),parseFloat(this.componentMarker.position[0]),parseFloat(this.info.location.lat),parseFloat(this.info.location.lng));if(!i||i>this.circles[0].radius)return weui.alert("不在签到范围内"),!1;var a={act_id:this.id,type:t,location:{lat:parseFloat(this.componentMarker.position[1]),lng:parseFloat(this.componentMarker.position[0])},enroll_id:this.info.enroll_id,is_outside:this.info.is_outside};d.b.post("/index.php?app=activity&m=act&cmd=114",{data:a}).then(function(t){0===Number(t.errcode)&&(weui.alert("签到成功"),e.showPage=!0)})},signedEventCode:function(t){var e=this,i={act_id:this.id,type:t};d.b.post("/index.php?app=activity&m=act&cmd=114",{data:i}).then(function(t){0===t.errcode&&(e.$toast.success("签到成功"),e.showPage=!0)})},success:function(){var t=this.shareMsg.appid,e=this.shareMsg.corpid,i=this.shareMsg.corpurl,a=this.info.shareId,n=this.id;this.$router.replace({path:"/activity/activitydetail?corpid="+e+"&corpurl="+i+"&appid="+t+"&id="+n+"&shareId="+a})},getDistance:function(t,e,i,a){var n=Math.PI;function s(t){return t*n/180}var r,o,c,p,u=s((t+i)/2),l=s((t-i)/2),d=s((e-a)/2),h=Math.sin(l),f=Math.sin(d),m=Math.sin(u);return r=(h*=h)*(1-(f*=f))+(1-(m*=m))*f,o=(1-h)*(1-f)+m*f,2*(c=Math.atan(Math.sqrt(r/o)))*6378137*(1+1/298.257*((3*(p=Math.sqrt(r*o)/c)-1)/2/o*m*(1-h)-(3*p+1)/2/r*(1-m)*h))},getMessage:function(){var t=this;return new n.a(function(e){d.b.post("/index.php?app=activity&m=act&cmd=115",{data:{act_id:t.id}}).then(function(i){t.info=i.info,t.info.start_time=u.a.unix(t.info.start_time).format("YYYY-MM-DD HH:mm:ss"),t.info.end_time=u.a.unix(t.info.end_time).format("YYYY-MM-DD HH:mm:ss"),t.center=[parseFloat(t.info.location.lng),parseFloat(t.info.location.lat)],t.center,t.circles=[{center:[parseFloat(t.info.location.lng),parseFloat(t.info.location.lat)],radius:t.info.sign_scope,fillOpacity:.5}],e(!0)})})}}},f={render:function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",[t.showPage?i("div",[1===Number(t.signType)?i("div",{staticClass:"position"},[i("div",{staticClass:"amap-wrapper"},[i("el-amap",{staticClass:"amap-demo",attrs:{vid:"amapDemo",zoom:t.zoom,center:t.center}},[i("el-amap-marker",{attrs:{vid:"component-marker",position:t.componentMarker.position}}),t._v(" "),t._l(t.circles,function(t,e){return i("el-amap-circle",{key:e,attrs:{center:t.center,radius:t.radius,"fill-opacity":t.fillOpacity,events:t.events}})})],2)],1),t._v(" "),i("div",{staticClass:"bottom_btn"},[i("a",{staticClass:"weui-btn weui-btn_primary btn",attrs:{href:"javascript:;"},on:{click:function(e){t.signedEvent(2)}}},[t._v("签到")]),t._v(" "),i("p",[t._v("签到时间：\n          "),i("span",[t._v(t._s(t.info.start_time))]),t._v("-\n          "),i("span",[t._v(t._s(t.info.end_time))])])])]):t._e(),t._v(" "),2===Number(t.signType)?i("div",{staticClass:"Scan_sign_in"},[i("div",{staticClass:"content"},[i("span",{staticClass:"rulericon rulericon-right"}),t._v(" "),i("p",{staticClass:"sign_success"},[t._v("签到成功")]),t._v(" "),i("p",{staticClass:"text"},[t._v("活动签到成功，点击可\n          "),i("span",{staticClass:"watch",on:{click:t.success}},[t._v("查看活动详情")])])]),t._v(" "),i("a",{staticClass:"weui-btn weui-btn_primary btn",attrs:{href:"javascript:;"},on:{click:t.success}},[t._v("确定")])]):t._e()]):t._e()])},staticRenderFns:[]};var m=i("VU/8")(h,f,!1,function(t){i("MMVV")},"data-v-1b142e75",null);e.default=m.exports},MMVV:function(t,e){}});